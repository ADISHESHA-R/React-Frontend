<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Checkout</title>
  <meta charset="UTF-8">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #f9f9f9, #f0f0f0);
      color: #333;
    }

    .checkout-container {
      max-width: 1000px;
      margin: 60px auto;
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.5s ease-in-out;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }

    .product {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e0e0e0;
      padding: 20px 0;
      transition: background 0.3s;
    }

    .product:hover { background: #fafafa; }

    .product img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #ddd;
    }

    .product-details {
      flex: 1;
      padding: 0 20px;
    }

    .product-details h3 { font-size: 20px; margin-bottom: 5px; }

    .product-details p { font-size: 16px; color: #555; }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }

    .quantity-controls button {
      background-color: #e0e0e0;
      border: none;
      padding: 6px 10px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s ease;
    }

    .quantity-controls button:hover { background-color: #d0d0d0; }

    .quantity-controls input {
      width: 50px;
      padding: 6px;
      text-align: center;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .remove-button {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .remove-button:hover { background: #c0392b; }

    .summary {
      margin-top: 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 2px solid #ddd;
      padding-top: 20px;
    }

    .total {
      font-size: 22px;
      font-weight: bold;
      color: #2c3e50;
    }

    .pay-button {
      background: #27ae60;
      color: white;
      border: none;
      padding: 14px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .pay-button:hover { background: #1e874b; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .checkout-container {
        margin: 20px auto;
        padding: 20px;
        max-width: 95%;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }

      .product {
        flex-direction: column;
        align-items: flex-start;
        padding: 15px 0;
        gap: 15px;
      }

      .product img {
        width: 80px;
        height: 80px;
        align-self: center;
      }

      .product-details {
        padding: 0;
        width: 100%;
        text-align: center;
      }

      .product-details h3 {
        font-size: 18px;
        margin-bottom: 8px;
      }

      .product-details p {
        font-size: 14px;
        margin-bottom: 10px;
      }

      .quantity-controls {
        justify-content: center;
        margin-top: 8px;
      }

      .quantity-controls button {
        padding: 8px 12px;
        font-size: 16px;
      }

      .quantity-controls input {
        width: 60px;
        padding: 8px;
        font-size: 14px;
      }

      .remove-button {
        align-self: center;
        padding: 10px 16px;
        font-size: 14px;
      }

      .summary {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .total {
        font-size: 20px;
      }

      .pay-button {
        padding: 12px 20px;
        font-size: 16px;
        width: 100%;
        max-width: 300px;
      }
    }

    @media (max-width: 480px) {
      .checkout-container {
        margin: 10px auto;
        padding: 15px;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 15px;
      }

      .product {
        padding: 12px 0;
        gap: 12px;
      }

      .product img {
        width: 70px;
        height: 70px;
      }

      .product-details h3 {
        font-size: 16px;
        margin-bottom: 6px;
      }

      .product-details p {
        font-size: 13px;
        margin-bottom: 8px;
      }

      .quantity-controls button {
        padding: 6px 10px;
        font-size: 14px;
      }

      .quantity-controls input {
        width: 50px;
        padding: 6px;
        font-size: 13px;
      }

      .remove-button {
        padding: 8px 12px;
        font-size: 13px;
      }

      .summary {
        gap: 12px;
      }

      .total {
        font-size: 18px;
      }

      .pay-button {
        padding: 10px 16px;
        font-size: 14px;
      }
    }

    @media (max-width: 360px) {
      .checkout-container {
        padding: 10px;
      }

      h1 {
        font-size: 18px;
      }

      .product img {
        width: 60px;
        height: 60px;
      }

      .product-details h3 {
        font-size: 14px;
      }

      .product-details p {
        font-size: 12px;
      }

      .quantity-controls button {
        padding: 4px 8px;
        font-size: 12px;
      }

      .quantity-controls input {
        width: 40px;
        padding: 4px;
        font-size: 12px;
      }

      .remove-button {
        padding: 6px 10px;
        font-size: 12px;
      }

      .total {
        font-size: 16px;
      }

      .pay-button {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>

<div class="checkout-container">
  <h1>Your Cart</h1>

  <div th:each="item : ${cartItems}" class="product"
       th:attr="data-id=${item.product.id},data-price=${item.product.price}">
    <img th:if="${item.product.imageName != null}" th:src="@{'/uploads/' + ${item.product.imageName}}" alt="Product Image" onerror="this.onerror=null;this.src='/images/no-image.svg';"/>
    <img th:if="${item.product.imageName == null}" src="/images/no-image.svg" alt="No Image"/>
    <div class="product-details">
      <h3 th:text="${item.product.name}">Product Name</h3>
      <p th:text="'Price: ‚Çπ' + ${item.product.price}">Price</p>
      <p class="item-total" th:text="'Item Total: ‚Çπ' + ${#numbers.formatDecimal(item.product.price * item.quantity, 1, 2)}">Item Total</p>

      <div class="quantity-controls">
        <button type="button" onclick="changeQuantity(this, -1)">‚àí</button>
        <input type="number" name="quantity" th:value="${item.quantity}" min="1"
               onchange="updateQuantity(this)" />
        <button type="button" onclick="changeQuantity(this, 1)">+</button>
      </div>
    </div>

    <form th:action="@{'/cart/remove/' + ${item.product.id}}" method="post">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <button class="remove-button" type="submit">Remove</button>
    </form>
  </div>

  <div class="summary">
    <div class="total">Total: ‚Çπ<span id="totalAmount" th:text="${total}">0</span></div>
    <!-- Show different buttons based on authentication status -->
    <button class="pay-button" type="button" onclick="startPayment()" th:if="${isUser}">Proceed to Payment</button>
    <a href="/login" class="pay-button" style="text-decoration: none; display: inline-block;" th:if="${!isUser}">Login to Checkout</a>
  </div>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  function changeQuantity(button, change) {
    const input = button.parentElement.querySelector('input[type="number"]');
    let value = parseInt(input.value);
    value = isNaN(value) ? 1 : value + change;
    if (value < 1) value = 1;
    input.value = value;
    updateQuantity(input);
  }

  function updateQuantity(input) {
    const productDiv = input.closest('.product');
    const productId = productDiv.getAttribute('data-id');
    const quantity = parseInt(input.value);
    
    // Validate quantity
    if (isNaN(quantity) || quantity < 1) {
      input.value = 1;
      alert('Quantity must be at least 1');
      return;
    }
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

    // Show loading state
    const originalValue = input.value;
    input.disabled = true;

    fetch(`/cart/update/${productId}`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/x-www-form-urlencoded',
        [csrfHeader]: csrfToken || ''
      },
      body: `quantity=${quantity}`
    }).then(response => {
      input.disabled = false;
      if (response.ok) {
        // Update the item total display
        const price = parseFloat(productDiv.getAttribute('data-price'));
        const itemTotal = price * quantity;
        const itemTotalElement = productDiv.querySelector('.item-total');
        if (itemTotalElement) {
          itemTotalElement.textContent = `Item Total: ‚Çπ${itemTotal.toFixed(2)}`;
        }
        // Recalculate and update grand total
        recalculateTotal();
      } else {
        input.value = originalValue;
        alert('Failed to update quantity. Please try again.');
      }
    }).catch(error => {
      input.disabled = false;
      input.value = originalValue;
      console.error('Error updating quantity:', error);
      alert('Failed to update quantity. Please try again.');
    });
  }

  function recalculateTotal() {
    const products = document.querySelectorAll('.product');
    let total = 0;
    products.forEach(product => {
      const price = parseFloat(product.getAttribute('data-price'));
      const qtyInput = product.querySelector('input[type="number"]');
      const qty = qtyInput ? parseInt(qtyInput.value) : 1;
      if (!isNaN(price) && !isNaN(qty)) {
        total += price * qty;
      }
    });
    const totalElement = document.getElementById('totalAmount');
    if (totalElement) {
      totalElement.textContent = total.toFixed(2);
    }
  }

  function startPayment() {
    const total = parseFloat(document.getElementById('totalAmount').innerText);
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

    fetch('/create-order', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        [csrfHeader]: csrfToken || ''
      },
      body: JSON.stringify({ amount: Math.round(total * 100) })
    })
    .then(res => res.json())
    .then(data => {
      const options = {
        key: 'rzp_test_E1v7jL3XBuxjgO', // Replace with your actual key
        amount: data.amount,
        currency: 'INR',
        name: 'HSK Shopping',
        description: 'Order Payment',
        order_id: data.id,
        handler: function (response) {
          fetch('/payment-success', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              [csrfHeader]: csrfToken || ''
            },
            body: JSON.stringify(response)
          }).then(() => {
            window.location.href = '/payment-success-page';
          });
        },
        prefill: {
          name: 'Customer',
          email: 'customer@example.com'
        },
        theme: { color: '#27ae60' }
      };
      const rzp = new Razorpay(options);
      rzp.open();
    });
  }

  window.onload = recalculateTotal;
</script>

<!-- Footer -->
<footer class="footer">
  <div class="footer-content">
    <div class="footer-section">
      <h3>Developer Information</h3>
      <div class="developer-info">
        <p><strong>Adishesha R</strong></p>
        <p>üìç Bangalore, Karnataka, India</p>
        <p>üìß adishesha.r@g10xtech.com</p>
        <p>üè¢ G10X Technology Private Limited</p>
      </div>
    </div>
    
    <div class="footer-section">
      <h3>Quick Links</h3>
      <ul class="footer-links">
        <li><a href="/">Home</a></li>
        <li><a href="/login">Login</a></li>
        <li><a href="/signup">Sign Up</a></li>
        <li><a href="/seller-login">Seller Login</a></li>
      </ul>
    </div>
    
    <div class="footer-section">
      <h3>Support</h3>
      <ul class="footer-links">
        <li><a href="/help-center">Help Center</a></li>
        <li><a href="/contact-us">Contact Us</a></li>
        <li><a href="/privacy-policy">Privacy Policy</a></li>
        <li><a href="/terms-of-service">Terms of Service</a></li>
      </ul>
    </div>
  </div>
  
  <div class="footer-bottom">
    <div class="footer-bottom-content">
      <p>&copy; 2024 HSK Shopping Platform. All rights reserved.</p>
    </div>
  </div>
</footer>

<style>
  /* Footer Styles */
  .footer {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: #ecf0f1;
    margin-top: 50px;
    padding: 0;
    box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.1);
  }

  .footer-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 30px;
    padding: 40px 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .footer-section h3 {
    color: #3498db;
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: 600;
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
  }

  .developer-info p {
    margin: 8px 0;
    font-size: 14px;
    line-height: 1.6;
  }

  .developer-info p:first-child {
    font-size: 16px;
    font-weight: 600;
    color: #e74c3c;
  }

  .footer-links {
    list-style: none;
    padding: 0;
  }

  .footer-links li {
    margin: 10px 0;
  }

  .footer-links a {
    color: #bdc3c7;
    text-decoration: none;
    transition: color 0.3s ease;
    font-size: 14px;
  }

  .footer-links a:hover {
    color: #3498db;
    text-decoration: underline;
  }

  .footer-bottom {
    background: rgba(0, 0, 0, 0.2);
    padding: 20px;
    border-top: 1px solid #34495e;
  }

  .footer-bottom-content {
    max-width: 1200px;
    margin: 0 auto;
    text-align: center;
  }

  .footer-bottom-content p {
    margin: 5px 0;
    font-size: 14px;
    color: #95a5a6;
  }

  .footer-bottom-content p:last-child {
    font-style: italic;
    color: #7f8c8d;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .footer-content {
      grid-template-columns: 1fr;
      gap: 20px;
      padding: 30px 15px;
    }
    
    .footer-section h3 {
      font-size: 16px;
    }
    
    .developer-info p,
    .footer-links a {
      font-size: 13px;
    }
    
    .footer-bottom-content p {
      font-size: 12px;
    }
  }
</style>

</body>
</html>
